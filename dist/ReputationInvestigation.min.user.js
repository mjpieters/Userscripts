// ==UserScript==
// @name         Reputation Investigation
// @namespace    https://gitlab.com/rjrudman/ReputationInvestigation
// @version      0.0.0
// @author       Robert Rudman
// @match        *://*.stackexchange.com/*/*?tab=reputation*
// @match        *://*.stackoverflow.com/users/*/*?tab=reputation*
// @match        *://*.superuser.com/*/*?tab=reputation*
// @match        *://*.serverfault.com/*/*?tab=reputation*
// @match        *://*.askubuntu.com/*/*?tab=reputation*
// @match        *://*.stackapps.com/*/*?tab=reputation*
// @match        *://*.mathoverflow.net/*/*?tab=reputation*
// @exclude      *://chat.stackexchange.com/*
// @exclude      *://chat.meta.stackexchange.com/*
// @exclude      *://chat.stackoverflow.com/*
// @exclude      *://blog.stackoverflow.com/*
// @exclude      *://*.area51.stackexchange.com/*
// @require      https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.22.2/moment.min.js
// @require      https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js
// @grant        GM_xmlhttpRequest
// ==/UserScript==
!function(t){function e(r){if(n[r])return n[r].exports;var o=n[r]={i:r,l:!1,exports:{}};return t[r].call(o.exports,o,o.exports,e),o.l=!0,o.exports}var n={};e.m=t,e.c=n,e.d=function(t,n,r){e.o(t,n)||Object.defineProperty(t,n,{configurable:!1,enumerable:!0,get:r})},e.n=function(t){var n=t&&t.__esModule?function(){return t.default}:function(){return t};return e.d(n,"a",n),n},e.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},e.p="",e(e.s=0)}([function(t,e,n){var r,o;r=[n,e,n(1),n(2),n(3)],void 0!==(o=function(t,e,n,r,o){"use strict";function a(t,e){return"hsla("+360/e*t*3%360+", 80%, 50%, 0.3)"}Object.defineProperty(e,"__esModule",{value:!0});var i=null;$(function(){n.AddStyleText("\n.detailed_reputation_table {\n    width: 100%;\n    font-size: 10px;\n}\n\n.detailed_reputation_table td {\n    padding: 5px;\n}\n\n.detailed_reputation_table tr:nth-child(even) {\n    background-color: #f2f2f2;\n}\n\n.detailed_reputation_table_header {\n    font-size: 12px;\n}\n\n.post-matcher {\n    opacity: 0;\n    padding-left: 5px;\n}\n\n.detailed_reputation_table tr > td.post-col:hover .post-matcher,\n.detailed_reputation_table_highlighted .post-matcher {\n    opacity: 1;\n}\n\n.user-details-div {\n    display: inline;\n    margin-left: 15px;\n}\n.user-details-div a {\n    margin-left: 5px;\n}\n"),$.event.special.destroyed={remove:function(t){t.handler&&t.handler()}},StackExchange.initialized.then(function(){function t(){var r=$('<a href="/users/'+n+'?tab=reputation&amp;sort=detailed">detailed</a>');if(window.location.href.match(u)){$(".user-tab-sorts a").removeClass("youarehere"),$(r).addClass("youarehere"),e(45,3,!1);var o=$('<a style="margin-left: 5px" href="https://stackoverflow.com/admin/xref-user-ips/'+n+'" target="_blank">xref</a>'),a=$('<a href="https://stackoverflow.com/admin/show-user-votes/'+n+'" target="_blank">votes</a>'),i=$('<input type="checkbox" id="chkShowReversedUser">'),c=$('<label for="chkShowReversedUser" style="margin-right: 15px; margin-left: 15px;">Show reversed user</label>');StackExchange.options.user.isModerator&&($("#stats").prepend(o),$("#stats").prepend(a),$("#stats").prepend(i),$("#stats").prepend(c));var s=$('<input type="number" value="3" />');$("#stats").prepend(s),$("#stats").prepend('<label style="margin-right: 15px; margin-left: 15px;">Set minimum bucket size</label>');var d=$('<input type="number" value="45" />');$("#stats").prepend(d),$("#stats").prepend('<label style="margin-right: 15px;">Set number of seconds between votes</label>');var p=function(){e(parseInt(d.val(),10),parseInt(s.val(),10),!!i.prop("checked"))};i.change(p),d.change(p),s.change(p)}r.bind("destroyed",function(){setTimeout(function(){t()})}),$(".user-tab-sorts").append(r)}function e(t,u,c){var s=$("#rep-page-container");s.empty();var d=$(".user-tab-footer");d.empty();var p=o.GetCurrentReputationPage(n),f=[],l=[];p.then(function(p){if(p.hasMore){var _=$('<a href="javascript:void(0);">Load more</a>');_.click(function(){_.hide(),o.GetNextReputationPage(n).then(function(){return e(t,u,c)})}),d.append(_)}var h=JSON.parse(JSON.stringify(p)),y=r.ProcessItems(h.items,t),v=y.filter(function(t){return t.length>=u}),m=$('\n                    <table class="detailed_reputation_table">\n                        <tbody id="detailed_reputation_body">\n                        </tbody>\n                    </table>\n                    '),b=["user_deleted","vote_fraud_reversal"],g=h.items.filter(function(t){return"user_deleted"===t.reputation_history_type}),x=h.items.filter(function(t){var e=moment.unix(t.creation_date).utc();return"vote_fraud_reversal"===t.reputation_history_type&&e.minute()<=5&&3===e.hour()}),w=h.items.filter(function(t){var e=moment.unix(t.creation_date).utc();return"vote_fraud_reversal"===t.reputation_history_type&&(e.minute()>5||3!==e.hour())});if(c&&h.items.find(function(t){return b.indexOf(t.reputation_history_type)>=0})&&null==i&&StackExchange.options.user.isModerator){var O="/admin/show-user-votes/"+n;i=fetch(O).then(function(t){return t.text()})}var S=m.find("#detailed_reputation_body");h.items.forEach(function(t){function e(){f.forEach(function(t){return t.removeClass("detailed_reputation_table_highlighted")}),f=[]}function n(t){f.forEach(function(t){return t.removeClass("detailed_reputation_table_highlighted")}),f=l[t],f.forEach(function(t){return t.addClass("detailed_reputation_table_highlighted")})}var r=t,o=r.bucket,u=v.indexOf(o),s=$("\n                    <tr>\n                        <td>"+moment.unix(t.creation_date).format("YYYY-MM-DD HH:mm:ss")+"</td>\n                        <td>"+t.reputation_history_type+"</td>\n                        <td>"+t.reputation_change+'</td>\n                        <td class="post-col"><a href="/q/'+t.post_id+'">'+t.post_id+'</a><a class="post-matcher" href="javascript:void(0);">ðŸ“Œ</a></td>\n                        <td class="reversal-type"></td>\n                    </tr>\n                    ');"association_bonus"===r.reputation_history_type&&s.find(".post-col").empty(),r.canIgnore&&s.css("text-decoration","line-through");var d=s.find(".post-matcher"),p=!1;d.click(function(){!p&&s.hasClass("detailed_reputation_table_highlighted")?e():(n(t.post_id),p=!1)});var _=s.find(".post-col");if(_.mouseenter(function(){f.length||(p=!0,n(t.post_id))}),_.mouseleave(function(){p&&(e(),p=!1)}),u>-1){var h=a(u,v.length),y=function(t,e){return t.post_id===e.post_id&&t.creation_date>e.creation_date},m=function(t,e){return t.post_id===e.post_id&&t.creation_date-r.creation_date<=86400&&t.creation_date>e.creation_date},O=function(t,e){return t.post_id===e.post_id&&t.creation_date>e.creation_date};if(r.firstInBucket)if(b.indexOf(r.reputation_history_type)>=0){var k=x.indexOf(r)>=0?"Automatically reversed":"vote_fraud_reversal"===r.reputation_history_type?"Manually reversed":"User deleted",P=$('\n                                <tr class="detailed_reputation_table_header">\n                                    <td colspan="5">\n                                        Group '+String.fromCharCode(65+u)+"\n                                        ("+o.length+" events, "+o.reduce(function(t,e){return t+e.reputation_change},0)+" reputation) - "+k+"\n                                    </td>\n                                </tr>\n                                ");P.css("background-color",h),S.append(P),i&&c&&i.then(function(t){var e=r.bucket.map(function(t){return t.creation_date}).filter(function(t,e,n){return n.indexOf(t)===e}),n=P.find("td"),o=[];e.forEach(function(e){var r=moment.unix(e).utc().format("YYYY-MM-DD HH:mm:ss")+"Z";$(".voters.sorter:eq(2)",t).find('[title="'+r+'"]').closest("tr").find(".user-info").each(function(t,e){var r=$(e),a=r.find(".gravatar-wrapper-32"),i=r.find(".user-details > a"),u=i.attr("href").match(/\/users\/(\d+)\//);if(u){var c=parseInt(u[1],10);if(o.indexOf(c)<0){var s=$('<div class="user-details-div">');s.append(a.css("display","inline-block")),s.append(i),n.append(s),o.push(c)}}})})}),P.css("background-color",h),S.append(P)}else{var j=$('\n                            <tr class="detailed_reputation_table_header">\n                                <td colspan="7">\n                                    Group '+String.fromCharCode(65+u)+"\n                                    ("+o.filter(function(t){return!t.canIgnore}).length+" events ("+o.length+" total), "+o.reduce(function(t,e){return t+e.reputation_change},0)+" reputation)\n                                    ("+o.reduce(function(t,e){return t+(null==g.find(function(t){return y(t,e)})?0:1)},0)+" UD)\n                                    ("+o.reduce(function(t,e){return t+(null==x.find(function(t){return m(t,e)})?0:1)},0)+" AR)\n                                    ("+o.reduce(function(t,e){return t+(null==w.find(function(t){return O(t,e)})?0:1)},0)+" MR)\n                                </td>\n                            </tr>\n                            ");j.css("background-color",h),S.append(j)}s.css("background-color",h);var I=[];b.indexOf(r.reputation_history_type)<0&&(g.find(function(t){return y(t,r)})&&I.push("UD"),x.find(function(t){return m(t,r)})&&I.push("AR"),w.find(function(t){return O(t,r)})&&I.push("MR"),s.find(".reversal-type").text(I.join(" ")))}S.append(s),l[t.post_id]||(l[t.post_id]=[]),l[t.post_id].push(s)}),s.append(m)})}var n=StackExchange.user.options.userId,u=/&sort=detailed/;t()})})}.apply(e,r))&&(t.exports=o)},function(t,e,n){var r,o;r=[n,e],void 0!==(o=function(t,e){"use strict";function n(t){var e=document.head||document.getElementsByTagName("head")[0],n=document.createElement("style");n.type="text/css",n.styleSheet?n.styleSheet.cssText=t:n.appendChild(document.createTextNode(t)),e.appendChild(n)}Object.defineProperty(e,"__esModule",{value:!0}),e.AddStyleText=n}.apply(e,r))&&(t.exports=o)},function(t,e,n){var r,o;r=[n,e],void 0!==(o=function(t,e){"use strict";function n(t){t.sort(function(t,e){var n=e.creation_date-t.creation_date;if(0!==n)return n;var r=t.post_id-e.post_id;if(0!==r)return r;var o=t.reputation_history_type.localeCompare(e.reputation_history_type);return 0!==o?o:t.reputation_change-e.reputation_change})}function r(t,e){var r=[];return n(t),t.forEach(function(t){if(o.indexOf(t.reputation_history_type)>=0){var n=r.find(function(n){if(!n.find(function(n){return n.creation_date-t.creation_date<e}))return!1;if("vote_fraud_reversal"===t.reputation_history_type&&n.find(function(e){return e.post_id===t.post_id}))return!1;if("post_upvoted"===t.reputation_history_type){if(n.filter(function(e){return e.post_id===t.post_id&&"post_upvoted"===e.reputation_history_type}).length-n.filter(function(e){return e.post_id===t.post_id&&"post_unupvoted"===e.reputation_history_type}).length>0)return!1}return!0}),a=t;if(n||(n=[],r.push(n),a.firstInBucket=!0),"post_upvoted"===t.reputation_history_type){var i=n.find(function(e){return e.post_id===t.post_id&&"post_unupvoted"===e.reputation_history_type&&e.creation_date>=t.creation_date&&!e.canIgnore});i&&(i.canIgnore=!0,a.canIgnore=!0)}var u=n;a.bucket=u,u.push(a)}}),r}Object.defineProperty(e,"__esModule",{value:!0});var o=["post_upvoted","user_deleted","post_unupvoted","vote_fraud_reversal"];e.ProcessItems=r}.apply(e,r))&&(t.exports=o)},function(t,e,n){var r,o;r=[n,e,n(4)],void 0!==(o=function(t,e,n){"use strict";function r(t){return n.__awaiter(this,void 0,void 0,function(){var e;return n.__generator(this,function(n){return e=new Promise(function(e,n){i?e(i):o(t).then(function(t){i?e(i):n()})}),[2,e]})})}function o(t){a++;var e="https://api.stackexchange.com/2.2/users/"+t+"/reputation-history?pagesize=100&page="+a+"&site=stackoverflow";return fetch(e).then(function(t){return t.json()}).then(function(t){i=i?{items:i.items.concat(t.items),hasMore:t.has_more}:{items:t.items,hasMore:t.has_more}})}Object.defineProperty(e,"__esModule",{value:!0});var a=0,i=null;e.GetCurrentReputationPage=r,e.GetNextReputationPage=o}.apply(e,r))&&(t.exports=o)},function(t,e,n){"use strict";function r(t,e){function n(){this.constructor=t}b(t,e),t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)}function o(t,e){var n={};for(var r in t)Object.prototype.hasOwnProperty.call(t,r)&&e.indexOf(r)<0&&(n[r]=t[r]);if(null!=t&&"function"==typeof Object.getOwnPropertySymbols)for(var o=0,r=Object.getOwnPropertySymbols(t);o<r.length;o++)e.indexOf(r[o])<0&&(n[r[o]]=t[r[o]]);return n}function a(t,e,n,r){var o,a=arguments.length,i=a<3?e:null===r?r=Object.getOwnPropertyDescriptor(e,n):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)i=Reflect.decorate(t,e,n,r);else for(var u=t.length-1;u>=0;u--)(o=t[u])&&(i=(a<3?o(i):a>3?o(e,n,i):o(e,n))||i);return a>3&&i&&Object.defineProperty(e,n,i),i}function i(t,e){return function(n,r){e(n,r,t)}}function u(t,e){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(t,e)}function c(t,e,n,r){return new(n||(n=Promise))(function(o,a){function i(t){try{c(r.next(t))}catch(t){a(t)}}function u(t){try{c(r.throw(t))}catch(t){a(t)}}function c(t){t.done?o(t.value):new n(function(e){e(t.value)}).then(i,u)}c((r=r.apply(t,e||[])).next())})}function s(t,e){function n(t){return function(e){return r([t,e])}}function r(n){if(o)throw new TypeError("Generator is already executing.");for(;c;)try{if(o=1,a&&(i=a[2&n[0]?"return":n[0]?"throw":"next"])&&!(i=i.call(a,n[1])).done)return i;switch(a=0,i&&(n=[0,i.value]),n[0]){case 0:case 1:i=n;break;case 4:return c.label++,{value:n[1],done:!1};case 5:c.label++,a=n[1],n=[0];continue;case 7:n=c.ops.pop(),c.trys.pop();continue;default:if(i=c.trys,!(i=i.length>0&&i[i.length-1])&&(6===n[0]||2===n[0])){c=0;continue}if(3===n[0]&&(!i||n[1]>i[0]&&n[1]<i[3])){c.label=n[1];break}if(6===n[0]&&c.label<i[1]){c.label=i[1],i=n;break}if(i&&c.label<i[2]){c.label=i[2],c.ops.push(n);break}i[2]&&c.ops.pop(),c.trys.pop();continue}n=e.call(t,c)}catch(t){n=[6,t],a=0}finally{o=i=0}if(5&n[0])throw n[1];return{value:n[0]?n[1]:void 0,done:!0}}var o,a,i,u,c={label:0,sent:function(){if(1&i[0])throw i[1];return i[1]},trys:[],ops:[]};return u={next:n(0),throw:n(1),return:n(2)},"function"==typeof Symbol&&(u[Symbol.iterator]=function(){return this}),u}function d(t,e){for(var n in t)e.hasOwnProperty(n)||(e[n]=t[n])}function p(t){var e="function"==typeof Symbol&&t[Symbol.iterator],n=0;return e?e.call(t):{next:function(){return t&&n>=t.length&&(t=void 0),{value:t&&t[n++],done:!t}}}}function f(t,e){var n="function"==typeof Symbol&&t[Symbol.iterator];if(!n)return t;var r,o,a=n.call(t),i=[];try{for(;(void 0===e||e-- >0)&&!(r=a.next()).done;)i.push(r.value)}catch(t){o={error:t}}finally{try{r&&!r.done&&(n=a.return)&&n.call(a)}finally{if(o)throw o.error}}return i}function l(){for(var t=[],e=0;e<arguments.length;e++)t=t.concat(f(arguments[e]));return t}function _(t){return this instanceof _?(this.v=t,this):new _(t)}function h(t,e,n){function r(t){d[t]&&(s[t]=function(e){return new Promise(function(n,r){p.push([t,e,n,r])>1||o(t,e)})})}function o(t,e){try{a(d[t](e))}catch(t){c(p[0][3],t)}}function a(t){t.value instanceof _?Promise.resolve(t.value.v).then(i,u):c(p[0][2],t)}function i(t){o("next",t)}function u(t){o("throw",t)}function c(t,e){t(e),p.shift(),p.length&&o(p[0][0],p[0][1])}if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var s,d=n.apply(t,e||[]),p=[];return s={},r("next"),r("throw"),r("return"),s[Symbol.asyncIterator]=function(){return this},s}function y(t){function e(e,o){t[e]&&(n[e]=function(n){return(r=!r)?{value:_(t[e](n)),done:"return"===e}:o?o(n):n})}var n,r;return n={},e("next"),e("throw",function(t){throw t}),e("return"),n[Symbol.iterator]=function(){return this},n}function v(t){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var e=t[Symbol.asyncIterator];return e?e.call(t):"function"==typeof p?p(t):t[Symbol.iterator]()}function m(t,e){return Object.defineProperty?Object.defineProperty(t,"raw",{value:e}):t.raw=e,t}Object.defineProperty(e,"__esModule",{value:!0}),e.__extends=r,n.d(e,"__assign",function(){return g}),e.__rest=o,e.__decorate=a,e.__param=i,e.__metadata=u,e.__awaiter=c,e.__generator=s,e.__exportStar=d,e.__values=p,e.__read=f,e.__spread=l,e.__await=_,e.__asyncGenerator=h,e.__asyncDelegator=y,e.__asyncValues=v,e.__makeTemplateObject=m;/*! *****************************************************************************
Copyright (c) Microsoft Corporation. All rights reserved.
Licensed under the Apache License, Version 2.0 (the "License"); you may not use
this file except in compliance with the License. You may obtain a copy of the
License at http://www.apache.org/licenses/LICENSE-2.0

THIS CODE IS PROVIDED ON AN *AS IS* BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
KIND, EITHER EXPRESS OR IMPLIED, INCLUDING WITHOUT LIMITATION ANY IMPLIED
WARRANTIES OR CONDITIONS OF TITLE, FITNESS FOR A PARTICULAR PURPOSE,
MERCHANTABLITY OR NON-INFRINGEMENT.

See the Apache Version 2.0 License for specific language governing permissions
and limitations under the License.
***************************************************************************** */
var b=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n])},g=Object.assign||function(t){for(var e,n=1,r=arguments.length;n<r;n++){e=arguments[n];for(var o in e)Object.prototype.hasOwnProperty.call(e,o)&&(t[o]=e[o])}return t}}]);